name: Release

on:
  pull_request:
    types: [closed]
    branches:
      - master

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create release and publish artifacts
    # Only run if PR was merged and has the release label
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Extract version from branch
        id: version
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"

          # Extract version from branch name (release/X.Y.Z)
          if [[ "$BRANCH" =~ ^release/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$VERSION" >> $GITHUB_OUTPUT
            echo "Extracted version: $VERSION"
          else
            echo "❌ Could not extract version from branch name: $BRANCH"
            exit 1
          fi

      - name: Create Git tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          echo "✅ Created and pushed tag $TAG"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract the section for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Get content for this version only: start at the matching version
            # header, stop when a different version header is encountered.
            # The range-based pattern /start/,/end/ cannot be used here because
            # the end pattern also matches the start line, causing awk to output
            # nothing. A flag-based approach is used instead.
            awk "/^## \[${VERSION}\]/{found=1} found && /^## \[/ && !/^## \[${VERSION}\]/{exit} found{print}" CHANGELOG.md > release_notes.md

            # If release notes are empty, use a default message
            if [ ! -s release_notes.md ]; then
              echo "Release $VERSION" > release_notes.md
            fi
          else
            echo "Release $VERSION" > release_notes.md
          fi

          # Append Docker container link
          {
            echo ""
            echo "## Docker Image"
            echo ""
            echo "The container image for this release is available on GitHub Packages:"
            echo ""
            echo '```'
            echo "ghcr.io/${{ github.repository_owner }}/queue-keeper:${VERSION}"
            echo '```'
            echo ""
            echo "Pull with:"
            echo ""
            echo '```sh'
            echo "docker pull ghcr.io/${{ github.repository_owner }}/queue-keeper:${VERSION}"
            echo '```'
          } >> release_notes.md

          echo "Extracted changelog for version $VERSION"

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Build CLI binaries for Linux
        run: |
          cargo build --release --package queue-keeper-cli

          # Copy binary to artifacts directory
          mkdir -p artifacts
          cp target/release/queue-keeper-cli artifacts/queue-keeper-cli-linux-x86_64

          echo "✅ Built Linux binary"

      - name: Build CLI binaries for Windows
        run: |
          # Install cross-compilation tools
          rustup target add x86_64-pc-windows-gnu

          # Install mingw for Windows cross-compilation
          sudo apt-get update
          sudo apt-get install -y mingw-w64

          cargo build --release --package queue-keeper-cli --target x86_64-pc-windows-gnu

          cp target/x86_64-pc-windows-gnu/release/queue-keeper-cli.exe artifacts/queue-keeper-cli-windows-x86_64.exe

          echo "✅ Built Windows binary"

      - name: Build CLI binaries for macOS
        run: |
          # Install cross-compilation tools for macOS
          rustup target add x86_64-apple-darwin

          # Note: Full macOS cross-compilation from Linux requires osxcross
          # For now, we'll document this limitation in the release notes
          echo "⚠️ macOS binary cross-compilation requires osxcross setup"
          echo "macOS users can build from source: cargo install queue-keeper-cli"

          # Create placeholder file explaining the situation
          cat > artifacts/README-macos.txt <<EOF
          macOS Binary Not Available

          Cross-compiling for macOS from Linux requires additional tooling (osxcross).

          macOS users can install queue-keeper-cli using cargo:

            cargo install queue-keeper-cli

          Or build from source:

            git clone https://github.com/pvandervelde/queue_keeper.git
            cd queue_keeper
            cargo build --release --package queue-keeper-cli

          The binary will be in: target/release/queue-keeper-cli
          EOF

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/queue-keeper:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/queue-keeper:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=Queue-Keeper
            org.opencontainers.image.description=GitHub webhook event processor with ordered delivery
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Create release with artifacts
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes-file release_notes.md \
            artifacts/queue-keeper-cli-linux-x86_64 \
            artifacts/queue-keeper-cli-windows-x86_64.exe \
            artifacts/README-macos.txt

          echo "✅ Created GitHub release $TAG"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          echo "✅ Release workflow completed successfully"
          echo ""
          echo "**Release Details:**"
          echo "  - Version: $VERSION"
          echo "  - Tag: $TAG"
          echo "  - Binaries: Linux (x86_64), Windows (x86_64)"
          echo "  - Docker: ghcr.io/${{ github.repository_owner }}/queue-keeper:$VERSION"
          echo "  - Docker: ghcr.io/${{ github.repository_owner }}/queue-keeper:latest"
          echo ""
          echo "**Artifacts:**"
          echo "  - queue-keeper-cli-linux-x86_64"
          echo "  - queue-keeper-cli-windows-x86_64.exe"
          echo ""
          echo "Release available at: ${{ github.event.repository.html_url }}/releases/tag/$TAG"
